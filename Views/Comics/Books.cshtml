@model LibraryViewModel

<div class="container">
    <div class="text-center my-5">
        <h1 class="display-4">@Model.Title</h1>
    </div>

    <partial name="_CardGrid" model="Model.Items" />

    <!-- Overlay spinner -->
    <div id="zip-overlay" class="zip-overlay d-none">
        <div class="zip-spinner">
            <div class="comic-spinner"><span>⏳</span></div>
            <p>Génération du ZIP...</p>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const overlay = document.getElementById("zip-overlay");

    document.querySelectorAll(".zip-btn").forEach(btn => {
        btn.addEventListener("click", async e => {
            e.preventDefault(); // <-- empêche le GET classique

            overlay.classList.remove("d-none");

            const category = @Html.Raw(Json.Serialize(@Model.Category));
            const series = @Html.Raw(Json.Serialize(@Model.Series));

            // Appel API
            const startResp = await fetch(
                `/Comics/DownloadSeries?category=${encodeURIComponent(category)}&series=${encodeURIComponent(series)}`
            );

            const startData = await startResp.json();

            const interval = setInterval(async () => {
                const statusResp = await fetch(
                    `/Comics/CheckZipStatus?category=${encodeURIComponent(category)}&series=${encodeURIComponent(series)}`
                );
                const statusData = await statusResp.json();

                if (statusData.status === "ready") {
                    clearInterval(interval);
                    overlay.classList.add("d-none");

                    // Téléchargement réel
                    window.location.href = statusData.url;
                }
            }, 5000);
        });
    });
});
</script>
