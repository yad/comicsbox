@model LibraryViewModel

<div class="container">
    <div class="text-center my-5">
        <h1 class="display-4">@Model.Title</h1>
    </div>

    <partial name="_CardGrid" model="Model.Items" />

    <!-- Overlay spinner -->
    <div id="zip-overlay" class="zip-overlay d-none">
        <div class="zip-spinner">
            <div class="comic-spinner"><span>⏳</span></div>
            <p>Génération du ZIP...</p>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const overlay = document.getElementById("zip-overlay");

    document.querySelectorAll(".zip-btn").forEach(btn => {
        btn.addEventListener("click", async e => {
            e.preventDefault(); // <-- empêche le GET classique
            overlay.classList.remove("d-none");

            const category = btn.dataset.category;
            const series = btn.dataset.series;

            // Lancer la génération ZIP via POST
            const resp = await fetch(`/Comics/DownloadSeries`, {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category, series })
            });
            const data = await resp.json();
            const url = data.url;

            // Polling jusqu'à ce que le ZIP soit prêt
            const interval = setInterval(async () => {
                const statusResp = await fetch(`/Comics/CheckZipStatus?category=${encodeURIComponent(category)}&series=${encodeURIComponent(series)}`);
                const statusData = await statusResp.json();

                if (statusData.status === "ready") {
                    clearInterval(interval);
                    overlay.classList.add("d-none");
                    window.location.href = statusData.url; // téléchargement
                }
            }, 1500);
        });
    });
});
</script>
