@model LibraryViewModel

<div class="container">
    <div class="text-center my-5">
        <h1 class="display-4">@Model.Title</h1>
    </div>

    <partial name="_CardGrid" model="Model.Items" />

    <!-- Overlay spinner -->
    <div id="zip-overlay" class="zip-overlay d-none">
        <div class="zip-spinner">
            <div class="comic-spinner"><span>⏳</span></div>
            <p>Génération du ZIP...</p>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const overlay = document.getElementById("zip-overlay");

    document.querySelectorAll(".zip-btn").forEach(btn => {
        btn.addEventListener("click", async e => {
            e.preventDefault(); // empêche le GET classique
            e.stopPropagation();

            overlay.classList.remove("d-none");

            // Récupère les infos depuis les data-attributes du bouton
            const category = btn.dataset.category;
            const series = btn.dataset.series;

            // Lancer génération ZIP via API RESTful
            const startResp = await fetch(`/Comics/Zip/${encodeURIComponent(category)}/${encodeURIComponent(series)}`);
            const startData = await startResp.json();

            // Polling pour vérifier quand le ZIP est prêt
            const interval = setInterval(async () => {
                const statusResp = await fetch(`/Comics/ZipStatus/${encodeURIComponent(category)}/${encodeURIComponent(series)}`);
                const statusData = await statusResp.json();

                if (statusData.status === "ready") {
                    clearInterval(interval);
                    overlay.classList.add("d-none");

                    // Téléchargement réel
                    window.location.href = `/Comics/ZipFile/${encodeURIComponent(category)}/${encodeURIComponent(series)}`;
                }
            }, 1500);
        });
    });
});
</script>
